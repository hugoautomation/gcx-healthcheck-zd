<div class="card mb-4">
    <div class="card-header">
        <h5 class="mb-0">Automated Monitoring Settings</h5>
    </div>
    <div class="card-body">
        <form method="POST" action="monitoring-settings/" data-is-free-plan="{{ is_free_plan|lower }}" id="monitoring-form">
            <input type="hidden" name="installation_id" value="{{ request.GET.installation_id }}">
            <input type="hidden" name="redirect_url" value="{{ request.get_full_path }}">
        
            <div class="row">
                <!-- Monitoring Status -->
                <div class="mb-3 col-md-6">
                    <label class="form-label">Monitoring Status</label>
                    <div class="form-check form-switch">
                        <input type="checkbox" class="form-check-input" id="is_active" name="is_active" 
                               {% if monitoring_settings.is_active %}checked{% endif %} 
                               {% if is_free_plan %}disabled{% endif %}>
                        <label class="form-check-label" for="is_active">Active</label>
                    </div>
                </div>
                
                <!-- Check Frequency -->
                <div class="mb-3 col-md-6">
                    <label for="frequency" class="form-label">Check Frequency</label>
                    <select class="form-select" id="frequency" name="frequency" 
                            {% if is_free_plan %}disabled{% endif %}>
                        <option value="daily" {% if monitoring_settings.frequency == 'daily' %}selected{% endif %}>Daily</option>
                        <option value="weekly" {% if monitoring_settings.frequency == 'weekly' %}selected{% endif %}>Weekly</option>
                        <option value="monthly" {% if monitoring_settings.frequency == 'monthly' %}selected{% endif %}>Monthly</option>
                    </select>
                </div>
                
                <!-- Notification Emails -->
            <div class="mb-3 col-12">
                <label for="notification_emails" class="form-label">Notification Emails</label>
                <div id="email-inputs">
                    <div class="row">
                        <div class="col-md-6">
                            {% for email in monitoring_settings.notification_emails %}
                            <div class="input-group mb-2">
                                <input type="email" class="form-control notification-email" name="notification_emails[]" 
                                       value="{{ email }}" {% if is_free_plan %}disabled{% endif %}>
                                <button type="button" class="btn c-btn c-btn--danger rounded-end remove-email" onclick="removeEmailField(this)">-</button>
                            </div>
                            {% endfor %}
                        </div>
                        <div class="col-md-6">
                            <div class="input-group mb-2">
                                <input type="email" class="form-control notification-email" name="notification_emails[]" 
                                       {% if is_free_plan %}disabled{% endif %}>
                                <button type="button" class="btn c-btn c-btn--success rounded-end add-email" onclick="addEmailField(this)">+</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            </div>

            {% if is_free_plan %}
            <a href="upgrade/" class="btn c-btn c-btn--primary c-btn--sm">Subscribe to Unlock</a>
            {% else %}
            <button type="submit" class="btn c-btn c-btn--primary c-btn--sm" id="save-settings-btn">
                <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                <span class="btn-text">Save Settings</span>
            </button>
                        {% endif %}
        </form>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('monitoring-form');
            const saveButton = document.getElementById('save-settings-btn');
            
            if (form && saveButton) {
                form.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    // Show loading state
                    const spinner = saveButton.querySelector('.spinner-border');
                    const btnText = saveButton.querySelector('.btn-text');
                    
                    spinner.classList.remove('d-none');
                    btnText.textContent = 'Saving...';
                    saveButton.disabled = true;
        
                    try {
                        // Get all email inputs that have values
                        const emailInputs = form.querySelectorAll('.notification-email');
                        const validEmails = Array.from(emailInputs)
                            .filter(input => input.value.trim() !== '')
                            .map(input => input.value.trim());
        
                        // Create FormData
                        const formData = new FormData(form);
        
                        // Remove existing email fields and add valid ones back
                        for (const pair of formData.entries()) {
                            if (pair[0] === 'notification_emails[]') {
                                formData.delete(pair[0]);
                            }
                        }
                        validEmails.forEach(email => {
                            formData.append('notification_emails[]', email);
                        });
        
                        // Submit form via fetch
                        const response = await fetch(form.action, {
                            method: 'POST',
                            body: formData
                        });
        
                        if (!response.ok) {
                            throw new Error('Failed to save settings');
                        }
        
                        // Redirect to the URL provided by the server
                        const redirectUrl = formData.get('redirect_url') || '/';
                        window.location.href = redirectUrl;
        
                    } catch (error) {
                        console.error('Error saving settings:', error);
                        // Reset button state
                        spinner.classList.add('d-none');
                        btnText.textContent = 'Save Settings';
                        saveButton.disabled = false;
                        // Show error message
                        alert('Failed to save settings. Please try again.');
                    }
                });
            }
        });
        </script>
</div>